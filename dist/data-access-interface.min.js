!function(t,e){"function"==typeof define&&define.amd?define(["EventDispatcher"],e):"object"==typeof module&&module.exports?module.exports=e(require("EventDispatcher")):t.DataAccessInterface=e(t.EventDispatcher)}(this,function(t){function e(){return"function"==typeof Proxy}function r(){}function n(t){var e;return t instanceof v?e=t.toJSON():t instanceof m?e=m.toJSON(t):t instanceof r||"function"==typeof t?e=j.pool.set(t).toJSON():u(t)&&(e=t),e}function o(t){var e=n(t);return e?e[d]:null}function i(t){var e;return t instanceof v||t instanceof m?e=t[l].id:u(t)&&(e=t[d].id),e}function s(t){var e;return u(t)&&(e=t[d].poolId),e}function u(t){return t instanceof v||t instanceof m||t&&"object"==typeof t[d]&&t[d]}function a(t){return u(t)||"function"==typeof t||t instanceof r}var c=Object.freeze({THEN:"then",CATCH:"catch",DESTROY_TARGET:"::destroy.resource"}),h=Object.freeze({PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"}),p=Object.freeze({DESTROY:c.DESTROY_TARGET}),f=Object.freeze({GET:"get",SET:"set",APPLY:"apply"}),l=Symbol("request.target:internals"),d="resource::data",y=function(){var t="DA/"+String(Date.now())+"/",e=0;return function(){return t+String(++e)+"/"+String(Date.now())}}(),E=function(){function t(){this._status=h.PENDING,this.promise=new Promise(function(t,e){this._resolveHandler=t,this._rejectHandler=e}.bind(this)),Object.defineProperties(this,{status:{get:e}})}function e(){return this._status}function r(){var t=this._resolveHandler.apply(null,arguments);return this._status=h.RESOLVED,t}function n(){var t=this._rejectHandler.apply(null,arguments);return this._status=h.REJECTED,t}function o(){return new t}return t.prototype.resolve=r,t.prototype.reject=n,o}(),v=function(){function t(t,u,a,c){Object.defineProperty(this,l,{value:{active:!0,pool:t,resource:u,type:a,id:c}}),Object.defineProperty(this,d,{get:e}),Object.defineProperties(this,{active:{get:r},poolId:{get:n},resource:{get:o},type:{get:i},id:{get:s}})}function e(){return this.toJSON()}function r(){return Boolean(this[l].active)}function n(){return this[l].pool?this[l].pool.id:null}function o(){return this[l].resource}function i(){return this[l].type||typeof this[l].resource}function s(){return this[l].id}function u(){var t={};return t[d]={id:this[l].id,type:this.type,poolId:this.poolId},t}function a(){var t=this[l].id,e=this[l].pool;if(this[l].active){this[l].active=!1,e.remove(t);for(var r in this[l])delete this[l][r]}}function c(e,r,n){return new t(e,r,n||y())}return t.prototype.toJSON=u,t.prototype.destroy=a,t.create=c,t}(),O=function(){function e(){this[l]=new Map,Object.defineProperties(this,{id:{value:y()}}),t.apply(this)}function r(t,r){var n=null;return e.isValidTarget(t)&&(this[l].has(t)?n=this[l].get(t):(n=v.create(this,t,r||typeof t),this[l].set(n.id,n),this[l].set(t,n),this.hasEventListener(f.RESOURCE_ADDED)&&this.dispatchEvent(f.RESOURCE_ADDED,n))),n}function n(t){return this[l].has(t)}function o(t){return this[l].get(t)}function i(t){var e=this[l].get(t);e&&(this[l]["delete"](e.id),this[l]["delete"](e.resource),this.hasEventListener(f.RESOURCE_REMOVED)&&this.dispatchEvent(f.RESOURCE_REMOVED,e),e.destroy())}function s(){this.hasEventListener(f.POOL_CLEAR)&&this.dispatchEvent(f.POOL_CLEAR,this);for(var t=this[l].keys(),e=t.length,r=0;e>r;r++){var n=t[r];if("string"==typeof n){var o=this[l].get(n);o.destroy()}}this[l].clear(),this.hasEventListener(f.POOL_CLEARED)&&this.dispatchEvent(f.POOL_CLEARED,this)}function u(){this.hasEventListener(f.POOL_DESTROY)&&this.dispatchEvent(f.POOL_DESTROY,this),this.clear(),this[l]=null,R.remove(this),this.hasEventListener(f.POOL_DESTROYED)&&this.dispatchEvent(f.POOL_DESTROYED,this)}function a(t){return t&&d[typeof t]}function c(t){d={};for(var e=t.length,r=0;e>r;r++)d[t[r]]=!0}function h(){return["object","function"]}function p(){return new e}var f=Object.freeze({RESOURCE_ADDED:"resourceAdded",RESOURCE_REMOVED:"resourceRemoved",POOL_CLEAR:"poolClear",POOL_CLEARED:"poolCleared",POOL_DESTROY:"poolDestroy",POOL_DESTROYED:"poolDestroyed"}),l=Symbol("TargetPool::map"),d={};return e.prototype=t.createNoInitPrototype(),e.prototype.constructor=e,e.prototype.set=r,e.prototype.has=n,e.prototype.get=o,e.prototype.remove=i,e.prototype.clear=s,e.prototype.destroy=u,e.isValidTarget=a,e.setValidTargets=c,e.getDefaultValidTargets=h,e.create=p,e.Events=f,e.setValidTargets(e.getDefaultValidTargets()),e}(),R=function(){function t(){var t=O.create();return e(t),t}function e(t){u[t.id]=t,t.addEventListener(O.Events.POOL_DESTROY,this._poolDestroyListener)}function r(t){return u[t]||null}function n(t){return u.hasOwnProperty(t instanceof O?t.id:String(t))}function o(t){var e=!1;return t=t instanceof O?t:r(t),t&&(t.removeEventListener(O.Events.POOL_DESTROY,this._poolDestroyListener),e=delete u[t.id]),e}function i(t){o(t.data)}function s(){}var u={};return s.prototype.createPool=t,s.prototype.register=e,s.prototype.get=r,s.prototype.isRegistered=n,s.prototype.remove=o,s.prototype._poolDestroyListener=i,new s}(),D=function(){function e(e,r){this[y]=e,t.apply(this),r&&r.setConverter(this)}function r(t){var e;return a(t)?e=n(t):"function"==typeof t.toJSON&&(e=t.toJSON()),e!==t&&this.hasEventListener(E.RESOURCE_CONVERTED)&&this.dispatchEvent(E.RESOURCE_CONVERTED,{data:t,result:e}),e}function o(t){var e,r=s(t);return R.isRegistered(r)?(t=R.get(r).get(i(t)),t&&(e=t.resource)):e=this[y].create(Promise.resolve(t)),e!==t&&this.hasEventListener(E.RESOURCE_CREATED)&&this.dispatchEvent(E.RESOURCE_CREATED,{data:t,result:e}),e}function c(t,e){for(var r=[],n=t.length,o=0;n>o;o++)r[o]=e.call(this,t[o]);return r}function h(t,e){var r={};for(var n in t)t.hasOwnProperty(n)&&(r[n]=e.call(this,t[n]));return r}function p(t){var e=t;return void 0!==t&&null!==t&&(a(t)?e=this.resourceToObject(t):t instanceof Array?e=this.lookupArray(t,this.resourceToObject):t.constructor===Object&&(e=this.lookupObject(t,this.resourceToObject))),e}function f(t){var e=t;return void 0!==t&&null!==t&&(u(t)?e=this.objectToResource(t):t instanceof Array?e=this.lookupArray(t,this.objectToResource):t.constructor===Object&&(e=this.lookupObject(t,this.objectToResource))),e}function l(t){function e(t){return m.isPending(t)&&r.push(t),t}var r=[];return"object"==typeof t&&null!==t&&(m.isPending(t)?r.push(t):t instanceof Array?this.lookupArray(t,e):t.constructor===Object&&this.lookupObject(t,e)),r}function d(t,r){return new e(t,r)}var y=Symbol("resource.converter::factory"),E=Object.freeze({RESOURCE_CREATED:"resourceCreated",RESOURCE_CONVERTED:"resourceConverted"});return e.prototype=t.createNoInitPrototype(),e.prototype.constructor=e,e.prototype.toJSON=p,e.prototype.parse=f,e.prototype.lookupArray=c,e.prototype.lookupObject=h,e.prototype.lookupForPending=l,e.prototype.resourceToObject=r,e.prototype.objectToResource=o,e.create=d,e.Events=E,e}(),g=function(){function t(){return!1}function e(r){function n(t){h=t}function o(t){var n=[];t=e.filterHandlers(t,n),r&&e.areProxyHandlersAvailable(t,!0),l=Boolean(n.length),f=t}function i(t){return f.hasOwnProperty(t)}function s(){return f}function u(t){return f[t]||null}function a(t,e,r){var n=h?h.lookupForPending(e.value):null;n&&n.length?Promise.all(n).then(function(){c(t,e.type,e,r)}):c(t,e.type,e,r)}function c(t,e,r,n){var o=u(e);"function"==typeof o&&o(t,r,n)}var h,p=t,f={},l=!1;Object.defineProperties(this,{isTemporary:{get:function(){return p},set:function(e){p="function"==typeof e?e:t}},available:{get:function(){return l}}}),this.setConverter=n,this.setHandlers=o,this.hasHandler=i,this.getHandlers=s,this.getHandler=u,this.handle=a}function r(t,e){var r={};for(var n in t)if(t.hasOwnProperty(n)&&"function"==typeof t[n]){if(n in c)throw new Error('Name "'+n+'" is reserved and cannot be used as command handler.');e.push(n),r[n]=t[n]}return r}function n(t){return new e(t)}function o(t,e){var r=!0;for(var n in f)if(f.hasOwnProperty(n)&&!(f[n]in t)&&(r=!1,e))throw new Error('For Proxy interface, handler "'+n+'" should be set.');return r}var i=Object.freeze({HANDLERS_UPDATED:"handlersUpdated"});return e.filterHandlers=r,e.areProxyHandlersAvailable=o,e.create=n,e.Events=i,e}(),P=function(){function t(t,e){function r(e){return o.hasOwnProperty(e)||(o[e]=function(e){function r(r,n){var o=this[l].sendRequest(e,r,n);return t.create(o||Promise.reject("Initial request failed and didn't result in promise."))}return r}(e)),o[e]}function n(t){var n=e.getHandlers();for(var o in n)n.hasOwnProperty(o)&&(t[o]=r(o));return t}var o={};this.decorate=n}function e(e){return new t(e)}return t.create=e,t}(),T=Symbol("request.factory::decorator"),b=Symbol("request.factory::handlers"),_=function(){function t(t){t!==o&&(this[b]=t,this[T]=new P(this,t))}function e(t){var e=m.create(t,this[b]);return this[b].available&&this[T].decorate(e),e}function r(e){return new t(e)}function n(){return new t(o)}var o={};return t.prototype.create=e,t.create=r,t.createNoInitProtoype=n,t}(),S=function(){function t(t,e,r){this._requestHandlers=r,this._requestTarget=t,this.link={},this.temporary,this.hadChildPromises=!1,this.status=h.PENDING,this.queue=[],this.promise=e.then(this._resolveHandler.bind(this),this._rejectHandler.bind(this))}function e(t){return this.status=h.RESOLVED,u(t)&&(this.link=o(t),this.temporary=this._requestHandlers.isTemporary(this._requestTarget),this.temporary&&this.queue[this.queue.length-1][1].promise.then(this.destroy.bind(this),this.destroy.bind(this)),t={target:this}),this._sendQueue(),t}function r(t){for(this.status=h.REJECTED;this.queue&&this.queue.length;){var e=this.queue.shift();e[1].reject(new Error("Target of the call was rejected and call cannot be sent."))}return this.queue=null,t}function n(){for(;this.queue&&this.queue.length;){var t=this.queue.shift(),e=t[0],r=t[1];e.target=this.link.id,this._requestHandlers.handle(this._requestTarget,e,r)}this.queue=null}function i(e,r,n){var o=null;if(!this._requestHandlers.hasHandler(e))throw new Error('Request handler of type "'+e+'" is not registered.');var i=t.createRequestPackage(e,r,n,this.id);return o=this._applyRequest(i,E())}function s(t,e){this.queue.push([t,e])}function a(t,e){var r=e.promise;t.type;switch(this.status){case h.PENDING:this._addToQueue(t,e);break;case h.REJECTED:r=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case h.DESTROYED:r=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case h.RESOLVED:this._requestHandlers.handle(this._requestTarget,t,e)}return r}function p(){return this.status===h.PENDING||this.status===h.RESOLVED}function f(){return this.status===h.RESOLVED&&this.link.id}function l(){var t=null;return this.canBeDestroyed()?(this.status=h.DESTROYED,t=this.sendRequest(c.DESTROY_TARGET)):t=Promise.reject(),t}function y(){var t=this.promise.then.apply(this.promise,arguments);return t&&(this.hadChildPromises=!0),t}function v(){var t=this.promise["catch"].apply(this.promise,arguments);return t&&(this.hadChildPromises=!0),t}function O(){var t={};return t[d]={id:this.link.id,type:this.link.type,poolId:this.link.poolId},t}function R(t,e,r,n){return{type:t,cmd:e,value:r,target:n}}return t.prototype._resolveHandler=e,t.prototype._rejectHandler=r,t.prototype._sendQueue=n,t.prototype.sendRequest=i,t.prototype._addToQueue=s,t.prototype._applyRequest=a,t.prototype.isActive=p,t.prototype.canBeDestroyed=f,t.prototype.destroy=l,t.prototype.then=y,t.prototype["catch"]=v,t.prototype.toJSON=O,t.createRequestPackage=R,t}(),m=function(){function t(t,e){Object.defineProperty(this,l,{value:new S(this,t,e)})}function e(){this[l].then.apply(this[l],arguments)}function r(){this[l]["catch"].apply(this[l],arguments)}function n(t){return t[l].isActive()}function o(t){return t[l].canBeDestroyed()}function i(t){return t[l].destroy()}function s(t){return t[l].toJSON()}function u(e){return e instanceof t&&p(e)==h.PENDING}function a(t){return Boolean(t[l].temporary)}function c(t,e){t[l].temporary=Boolean(e)}function p(t){return t[l].status}function f(t){var e=t[l].queue;return e?e.length:0}function d(t){var e,r=[],n=t[l].queue;if(n){e=n.length;for(var o=0;e>o;o++)r.push(n[o][0].type)}return r}function y(t){return t[l].hadChildPromises}function E(e,r){return new t(e,r)}return t.prototype.then=e,t.prototype["catch"]=r,t.isActive=n,t.canBeDestroyed=o,t.destroy=i,t.toJSON=s,t.isPending=u,t.isTemporary=a,t.setTemporary=c,t.getStatus=p,t.getQueueLength=f,t.getQueueCommands=d,t.hadChildPromises=y,t.create=E,t}(),j=function(){function t(t){if(t&&!e())throw new Error("Proxies are not available in this environment");var r=g.create(t),n=(t?RequestProxyFactory:_).create(r);Object.defineProperties(this,{poolRegistry:{value:R},pool:{value:R.createPool()},resourceConverter:{value:D.create(n,r)},factory:{value:n},proxyEnabled:{value:t}}),this.setHandlers=r.setHandlers}function n(t){return this.resourceConverter.parse(t)}function o(t){return this.resourceConverter.toJSON(t)}function i(e){return new t(e)}return t.prototype.parse=n,t.prototype.toJSON=o,t.create=i,t.IConvertible=r,t.RequestTarget=m,t.RequestTargetCommands=p,t.ProxyCommands=f,t.TargetPoolEvents=O.Events,t.ResourceConverterEvents=D.Events,t}();return j});
!function(e,t){"function"==typeof define&&define.amd?define(["EventDispatcher"],t):"object"==typeof module&&module.exports?module.exports=t(require("EventDispatcher")):e.DataAccessInterface=t(e.EventDispatcher)}(this,function(e){function t(){return"function"==typeof Proxy}function r(){}function n(e,t){t=t||ResourcePoolRegistry.defaultResourcePool;var n=null;return e instanceof p?n=e.toJSON():"object"==typeof e[l]?n=P.toJSON(e):e instanceof r||"function"==typeof e?n=t.set(e).toJSON():u(e)&&(n=e),n}function o(e){var t=n(e);return t?t[h]:null}function i(e){var t=null;return"object"==typeof e[l]?t=e[l].id:u(e)&&(t=e[h].id),t}function s(e){var t=null;return"object"==typeof e[l]?t=e[l].poolId:u(e)&&(t=e[h].poolId),t}function u(e){return e instanceof p||e instanceof P||e&&("object"==typeof e[l]||"object"==typeof e[h])}function a(e){return u(e)||"function"==typeof e||e instanceof r}var c=Object.freeze({PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"}),l=Symbol("request.target:internals"),h="resource::data",f=function(){var e="DA/"+String(Date.now())+"/",t=0;return function(){return e+String(++t)+"/"+String(Date.now())}}(),d=function(){function e(){this._status=c.PENDING,this.promise=new Promise(function(e,t){this._resolveHandler=e,this._rejectHandler=t}.bind(this)),Object.defineProperties(this,{status:{get:t}})}function t(){return this._status}function r(){var e=this._resolveHandler.apply(null,arguments);return this._status=c.RESOLVED,e}function n(){var e=this._rejectHandler.apply(null,arguments);return this._status=c.REJECTED,e}function o(){return new e}return e.prototype.resolve=r,e.prototype.reject=n,o}(),p=function(){function e(e,u,a,c){Object.defineProperty(this,l,{value:{active:!0,pool:e,poolId:e?e.id:null,resource:u,type:a,id:c}}),Object.defineProperty(this,h,{get:t}),Object.defineProperties(this,{active:{get:r},poolId:{get:n},resource:{get:o},type:{get:i},id:{get:s}})}function t(){return this.toJSON()}function r(){return Boolean(this[l].active)}function n(){return this[l].poolId}function o(){return this[l].resource}function i(){return this[l].type||typeof this[l].resource}function s(){return this[l].id}function u(){var e={};return e[h]={id:this[l].id,type:this.type,poolId:this.poolId},e}function a(){var e=this[l].id,t=this[l].pool;if(this[l].active){this[l].active=!1,t.remove(e);for(var r in this[l])delete this[l][r]}}function c(t,r,n,o){return new e(t,r,n,o||f())}return e.prototype.toJSON=u,e.prototype.destroy=a,e.create=c,e}(),y=function(){function t(t,r,n){this[y]=t,this[v]=r,e.apply(this),n&&n.setConverter(this)}function r(e){var t;return a(e)?t=n(e,this[v]):"function"==typeof e.toJSON&&(t=e.toJSON()),t!==e&&this.hasEventListener(m.RESOURCE_CONVERTED)&&this.dispatchEvent(m.RESOURCE_CONVERTED,{data:e,result:t}),t}function o(e){var t,r=s(e);return ResourcePoolRegistry.isRegistered(r)?(e=ResourcePoolRegistry.get(r).get(i(e)),e&&(t=e.resource)):t=this[y].create(Promise.resolve(e)),t!==e&&this.hasEventListener(m.RESOURCE_CREATED)&&this.dispatchEvent(m.RESOURCE_CREATED,{data:e,result:t}),t}function c(e,t){for(var r=[],n=e.length,o=0;n>o;o++)r[o]=t.call(this,e[o]);return r}function l(e,t){var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]=t.call(this,e[n]));return r}function h(e){var t=e;return void 0!==e&&null!==e&&(a(e)?t=this.resourceToObject(e):e instanceof Array?t=this.lookupArray(e,this.resourceToObject):e.constructor===Object&&(t=this.lookupObject(e,this.resourceToObject))),t}function f(e){var t=e;return void 0!==e&&null!==e&&(u(e)?t=this.objectToResource(e):e instanceof Array?t=this.lookupArray(e,this.objectToResource):e.constructor===Object&&(t=this.lookupObject(e,this.objectToResource))),t}function d(e){function t(e){return P.isPending(e)&&r.push(e),e}var r=[];return"object"==typeof e&&null!==e&&(P.isPending(e)?r.push(e):e instanceof Array?this.lookupArray(e,t):e.constructor===Object&&this.lookupObject(e,t)),r}function p(e,r,n){return new t(e,r,n)}var y=Symbol("resource.converter::factory"),v=Symbol("resource.converter::resourcePool"),m=Object.freeze({RESOURCE_CREATED:"resourceCreated",RESOURCE_CONVERTED:"resourceConverted"});return t.prototype=e.createNoInitPrototype(),t.prototype.constructor=t,t.prototype.toJSON=h,t.prototype.parse=f,t.prototype.lookupArray=c,t.prototype.lookupObject=l,t.prototype.lookupForPending=d,t.prototype.resourceToObject=r,t.prototype.objectToResource=o,t.create=p,t.Events=m,t}(),v=function(){function e(r){function n(e){h=e}function o(t){d={},e.filterHandlers(t,d),f=Object.getOwnPropertyNames(d).concat(Object.getOwnPropertySymbols(d)),r&&e.areProxyHandlersAvailable(d,!0)}function i(e){return d.hasOwnProperty(e)}function s(){return d}function u(){return f.slice()}function a(e){return d[e]||null}function c(e,t,r,n){var o=h?h.lookupForPending(r.value):null;o&&o.length?Promise.all(o).then(function(){l(e,t,r,n)}):l(e,t,r,n)}function l(e,t,r,n){var o=a(t);o instanceof CommandDescriptor&&o.handle(e,r,n)}var h,f=[],d={};r=Boolean(r),Object.defineProperties(this,{proxyEnabled:{value:r},available:{get:function(){return f.length}}}),this.setConverter=n,this.setHandlers=o,this.hasHandler=i,this.getHandlers=s,this.getHandlerNames=u,this.getHandler=a,this.handle=c,this[Symbol.iterator]=function(){return new t(this.getHandlers(),this.getHandlerNames())}}function t(e,t){function r(){var r;return r=++o>=n?{done:!0}:{value:e[t[o]],done:!1}}var n=t.length,o=-1;this.next=r,this[Symbol.iterator]=function(){return this}.bind(this)}function r(t){return new e(t)}function n(e,t){for(var r=!0,n=ProxyCommands.list,o=n.length,i=0;o>i;i++){var s=n[i];if(!(ProxyCommands.fields[s]in e)&&(r=!1,t))throw new Error('For Proxy interface, handler "'+s+'" should be set.')}return r}var o=Object.freeze({HANDLERS_UPDATED:"handlersUpdated"}),i=function(){function e(e,t){for(var n=e.length,o=0;n>o;o++){var i=e[o];i instanceof CommandDescriptor&&r(i,t)}}function t(e,t){for(var n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e)),o=n.length,i=0;o>i;i++){var s=n[i],u=e[s];"function"==typeof u&&(u=CommandDescriptor.create(s,u)),u instanceof CommandDescriptor&&r(u,t)}}function r(e,t){var r=e.name,n=e.type;if(n in Reserved.commands)throw new Error('Command "'+n+'" is reserved and cannot be used in descriptor.');if(r in Reserved.names)throw new Error('Name "'+r+'" is reserved and cannot be used in descriptor.');if(t.hasOwnProperty(r)&&t[r]instanceof CommandDescriptor)throw new Error('Field names should be unique, "'+String(r)+'" field has duplicates.');t[r]=e}function n(r,n){r instanceof Array?e(r,n):t(r,n)}return n}();return e.filterHandlers=i,e.areProxyHandlersAvailable=n,e.create=r,e.Events=o,e}(),m=function(){function e(e,t){function r(t,r){function n(n,o){var i=this[l].sendRequest(t,r,n,o);return e.create(i||Promise.reject("Initial request failed and didn't result in promise."))}return o.hasOwnProperty(t)||(o[t]=n),o[t]}function n(e){if(t.available){for(var n,o=t[Symbol.iterator]();!(n=o.next()).done;){var i=n.value;e[i.name]=r(i.name,i.type)}return e}}var o={};this.decorate=n}function t(t,r){return new e(t,r)}return e.create=t,e}(),E=Symbol("request.factory::decorator"),g=Symbol("request.factory::handlers"),b=function(){function e(e){e!==o&&(this[g]=e,this[E]=m.create(this,e))}function t(e){var t=P.create(e,this[g]);return this[g].available&&this[E].decorate(t),t}function r(t){return new e(t)}function n(){return new e(o)}var o={};return e.prototype.create=t,e.create=r,e.createNoInitProtoype=n,e}(),R=function(){function e(e,o,i){this._requestHandlers=i,this._requestTarget=e,this.link={},this.temporary,this.hadChildPromises=!1,this.status=c.PENDING,this.queue=[],this.promise=o.then(this._resolveHandler.bind(this),this._rejectHandler.bind(this)),Object.defineProperties(this,{poolId:{get:t},type:{get:r},id:{get:n}})}function t(){return this.link.poolId||null}function r(){return this.link.type||null}function n(){return this.link.id||null}function i(e){return this.status=c.RESOLVED,u(e)&&(this.link=o(e),this.temporary=this._requestHandlers.isTemporary(this._requestTarget),this.temporary&&this.queue[this.queue.length-1][1].promise.then(this.destroy.bind(this),this.destroy.bind(this)),e={target:this}),this._sendQueue(),e}function s(e){for(this.status=c.REJECTED;this.queue&&this.queue.length;){var t=this.queue.shift();t[1].reject(new Error("Target of the call was rejected and call cannot be sent."))}return this.queue=null,e}function a(){for(;this.queue&&this.queue.length;){var e=this.queue.shift(),t=e[0],r=e[1],n=e[2];r.target=this.link.id,this._requestHandlers.handle(this._requestTarget,t,r,n)}this.queue=null}function l(t,r,n,o){var i=null;if(!this._requestHandlers.hasHandler(t))throw new Error('Request handler of type "'+r+'" is not registered.');var s=e.createRequestPackage(r,n,o,this.id);return i=this._applyRequest(t,s,d())}function f(e,t,r){this.queue.push([e,t,r])}function p(e,t,r){var n=r.promise;switch(this.status){case c.PENDING:this._addToQueue(e,t,r);break;case c.REJECTED:n=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case c.DESTROYED:n=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case c.RESOLVED:this._requestHandlers.handle(this._requestTarget,e,t,r)}return n}function y(){return this.status===c.PENDING||this.status===c.RESOLVED}function v(){return this.status===c.RESOLVED&&this.link.id}function m(){var e=null;return this.canBeDestroyed()?(this.status=c.DESTROYED,e=this.sendRequest(RequestTargetCommands.DESTROY)):e=Promise.reject(),e}function E(){var e=this.promise.then.apply(this.promise,arguments);return e&&(this.hadChildPromises=!0),e}function g(){var e=this.promise["catch"].apply(this.promise,arguments);return e&&(this.hadChildPromises=!0),e}function b(){var e={};return e[h]={id:this.link.id,type:this.link.type,poolId:this.link.poolId},e}function R(e,t,r,n){return{type:e,cmd:t,value:r,target:n}}return e.prototype._resolveHandler=i,e.prototype._rejectHandler=s,e.prototype._sendQueue=a,e.prototype.sendRequest=l,e.prototype._addToQueue=f,e.prototype._applyRequest=p,e.prototype.isActive=y,e.prototype.canBeDestroyed=v,e.prototype.destroy=m,e.prototype.then=E,e.prototype["catch"]=g,e.prototype.toJSON=b,e.createRequestPackage=R,e}(),P=function(){function e(e,t){Object.defineProperty(this,l,{value:new R(this,e,t)})}function t(){this[l].then.apply(this[l],arguments)}function r(){this[l]["catch"].apply(this[l],arguments)}function n(e){return e[l].isActive()}function o(e){return e[l].canBeDestroyed()}function i(e){return e[l].destroy()}function s(e){return e[l].toJSON()}function u(t){return t instanceof e&&f(t)==c.PENDING}function a(e){return Boolean(e[l].temporary)}function h(e,t){e[l].temporary=Boolean(t)}function f(e){return e[l].status}function d(e){var t=e[l].queue;return t?t.length:0}function p(e){var t,r=[],n=e[l].queue;if(n){t=n.length;for(var o=0;t>o;o++)r.push(n[o][0].type)}return r}function y(e){return e[l].hadChildPromises}function v(t,r){return new e(t,r)}return e.prototype.then=t,e.prototype["catch"]=r,e.isActive=n,e.canBeDestroyed=o,e.destroy=i,e.toJSON=s,e.isPending=u,e.isTemporary=a,e.setTemporary=h,e.getStatus=f,e.getQueueLength=d,e.getQueueCommands=p,e.hadChildPromises=y,e.create=v,e}(),O=function(){function e(e,r,n){if(e&&!t())throw new Error("Proxies are not available in this environment");var o=v.create(e),i=(e?RequestProxyFactory:b).create(o);r=r||ResourcePoolRegistry.create(),n?r.register(n):n=void 0!==n?r.createPool():ResourcePoolRegistry.defaultResourcePool,Object.defineProperties(this,{poolRegistry:{value:r},pool:{value:n},resourceConverter:{value:y.create(i,n,o)},factory:{value:i},proxyEnabled:{get:function(){return o.proxyEnabled}}}),this.setHandlers=o.setHandlers}function n(e){return this.resourceConverter.parse(e)}function o(e){return this.resourceConverter.toJSON(e)}function i(t){return new e(t)}return e.prototype.parse=n,e.prototype.toJSON=o,e.create=i,e.IConvertible=r,e.RequestTarget=P,e.Reserved=Reserved,e.RequestTargetCommands=RequestTargetCommands,e.CommandDescriptor=CommandDescriptor,e.ProxyCommands=ProxyCommands,e.ResourcePool=ResourcePool,e.ResourcePoolRegistry=ResourcePoolRegistry,e.ResourceConverter=y,e}();return O});
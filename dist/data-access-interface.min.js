!function(t,e){"function"==typeof define&&define.amd?define(["EventDispatcher"],e):"object"==typeof module&&module.exports?module.exports=e(require("EventDispatcher")):t.DataAccessInterface=e(t.EventDispatcher)}(this,function(t){function e(){}function r(t){var r;return t instanceof E?r=t.toJSON():t instanceof D?r=D.toJSON(t):t instanceof e||"function"==typeof t?r=g.pool.set(t).toJSON():u(t)&&(r=t),r}function n(t){var e=r(t);return e?e[l]:null}function o(t){var e;return t instanceof E||t instanceof D?e=t[p].id:u(t)&&(e=t[l].id),e}function i(t){var e;return u(t)&&(e=t[l].poolId),e}function s(t){var e;return u(t)&&(e=t[l].type),e}function u(t){return t instanceof E||t instanceof D||t&&"object"==typeof t[l]&&t[l]}function a(t){return u(t)||"function"==typeof t||t instanceof e}var c={GET:"get",SET:"set",CALL:"call",EXEC:"exec",DESTROY_TARGET:"destroyTarget"},h={PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"},p=Symbol("request.target:internals"),l="resource::data",f=function(){var t="DA/"+String(Date.now())+"/",e=0;return function(){return t+String(++e)+"/"+String(Date.now())}}(),d=function(){function t(){this._status=h.PENDING,this.promise=new Promise(function(t,e){this._resolveHandler=t,this._rejectHandler=e}.bind(this)),Object.defineProperties(this,{status:{get:e}})}function e(){return this._status}function r(){var t=this._resolveHandler.apply(null,arguments);return this._status=h.RESOLVED,t}function n(){var t=this._rejectHandler.apply(null,arguments);return this._status=h.REJECTED,t}function o(){return new t}return t.prototype.resolve=r,t.prototype.reject=n,o}(),E=function(){function t(t,u,a){Object.defineProperty(this,p,{value:{active:!0,pool:t,resource:u,id:a}}),Object.defineProperty(this,l,{get:e}),Object.defineProperties(this,{active:{get:r},poolId:{get:n},resource:{get:o},type:{get:i},id:{get:s}})}function e(){return this.toJSON()}function r(){return Boolean(this[p].active)}function n(){return this[p].pool?this[p].pool.id:null}function o(){return this[p].resource}function i(){return typeof this.resource}function s(){return this[p].id}function u(){var t={};return t[l]={id:this[p].id,type:this.type,poolId:this.poolId},t}function a(){var t=this[p].id,e=this[p].pool;if(this[p].active){this[p].active=!1,e.remove(t);for(var r in this[p])delete this[p][r]}}function c(e,r,n){return new t(e,r,n||f())}return t.prototype.toJSON=u,t.prototype.destroy=a,t.create=c,t}(),y=function(){function e(){this[d]=new Map,Object.defineProperties(this,{id:{value:f()}}),t.apply(this)}function r(t){var r=null;return e.isValidTarget(t)&&(this[d].has(t)?r=this[d].get(t):(r=E.create(this,t),this[d].set(r.id,r),this[d].set(t,r),this.hasEventListener(l.RESOURCE_ADDED)&&this.dispatchEvent(l.RESOURCE_ADDED,r))),r}function n(t){return this[d].has(t)}function o(t){return this[d].get(t)}function i(t){var e=this[d].get(t);e&&(this[d]["delete"](e.id),this[d]["delete"](e.resource),this.hasEventListener(l.RESOURCE_REMOVED)&&this.dispatchEvent(l.RESOURCE_REMOVED,e),e.destroy())}function s(){this.hasEventListener(l.POOL_CLEAR)&&this.dispatchEvent(l.POOL_CLEAR,this);for(var t=this[d].keys(),e=t.length,r=0;e>r;r++){var n=t[r];if("string"==typeof n){var o=this[d].get(n);o.destroy()}}this[d].clear(),this.hasEventListener(l.POOL_CLEARED)&&this.dispatchEvent(l.POOL_CLEARED,this)}function u(){this.hasEventListener(l.POOL_DESTROY)&&this.dispatchEvent(l.POOL_DESTROY,this),this.clear(),this[d]=null,v.remove(this),this.hasEventListener(l.POOL_DESTROYED)&&this.dispatchEvent(l.POOL_DESTROYED,this)}function a(t){return t&&y[typeof t]}function c(t){y={};for(var e=t.length,r=0;e>r;r++)y[t[r]]=!0}function h(){return["object","function"]}function p(){return new e}var l={RESOURCE_ADDED:"resourceAdded",RESOURCE_REMOVED:"resourceRemoved",POOL_CLEAR:"poolClear",POOL_CLEARED:"poolCleared",POOL_DESTROY:"poolDestroy",POOL_DESTROYED:"poolDestroyed"},d=Symbol("TargetPool::map"),y={};return e.prototype=t.createNoInitPrototype(),e.prototype.constructor=e,e.prototype.set=r,e.prototype.has=n,e.prototype.get=o,e.prototype.remove=i,e.prototype.clear=s,e.prototype.destroy=u,e.isValidTarget=a,e.setValidTargets=c,e.getDefaultValidTargets=h,e.create=p,e.Events=l,e.setValidTargets(e.getDefaultValidTargets()),e}(),v=function(){function t(){var t=y.create();return e(t),t}function e(t){u[t.id]=t,t.addEventListener(y.Events.POOL_DESTROY,this._poolDestroyListener)}function r(t){return u[t]||null}function n(t){return u.hasOwnProperty(t instanceof y?t.id:String(t))}function o(t){var e=!1;return t=t instanceof y?t:r(t),t&&(t.removeEventListener(y.Events.POOL_DESTROY,this._poolDestroyListener),e=delete u[t.id]),e}function i(t){o(t.data)}function s(){}var u={};return s.prototype.createPool=t,s.prototype.register=e,s.prototype.get=r,s.prototype.isRegistered=n,s.prototype.remove=o,s.prototype._poolDestroyListener=i,new s}(),O=function(){function e(t){var e;return a(t)?e=r(t):"function"==typeof t.toJSON&&(e=t.toJSON()),e!==t&&this.hasEventListener(f.RESOURCE_CONVERTED)&&this.dispatchEvent(f.RESOURCE_CONVERTED,{data:t,result:e}),e}function n(t,e){var r,n=i(t);return v.isRegistered(n)?(t=v.get(n).get(o(t)),t&&(r=t.resource)):r=new D(Promise.resolve(t),e),r!==t&&this.hasEventListener(f.RESOURCE_CREATED)&&this.dispatchEvent(f.RESOURCE_CREATED,{data:t,result:r}),r}function s(t,e,r){for(var n=[],o=t.length,i=0;o>i;i++)n[i]=e.call(this,t[i],r);return n}function c(t,e,r){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=e.call(this,t[o],r));return n}function h(t){var e=t;return void 0!==t&&null!==t&&(a(t)?e=this.resourceToObject(t):t instanceof Array?e=this.lookupArray(t,this.resourceToObject):t.constructor===Object&&(e=this.lookupObject(t,this.resourceToObject))),e}function p(t,e){var r=t;return void 0!==t&&null!==t&&(u(t)?r=this.objectToResource(t,e):t instanceof Array?r=this.lookupArray(t,this.objectToResource,e):t.constructor===Object&&(r=this.lookupObject(t,this.objectToResource,e))),r}function l(){t.apply(this)}var f={RESOURCE_CREATED:"resourceCreated",RESOURCE_CONVERTED:"resourceConverted"};return l.prototype=t.createNoInitPrototype(),l.prototype.constructor=l,l.prototype.toJSON=h,l.prototype.parse=p,l.prototype.lookupArray=s,l.prototype.lookupObject=c,l.prototype.resourceToObject=e,l.prototype.objectToResource=n,new l}(),R=function(){function t(t,e){this._requestHandlers=e,this.link={},this.temporary,this.hadChildPromises=!1,this.status=h.PENDING,this.queue=[],this.promise=t.then(this._resolveHandler.bind(this),this._rejectHandler.bind(this))}function e(e){return this.status=h.RESOLVED,u(e)&&(this.link=n(e),this.temporary=t.isTemporary(this,e),this.temporary&&this.queue[this.queue.length-1][1].promise.then(this.destroy.bind(this),this.destroy.bind(this)),e={target:this}),this._sendQueue(),e}function r(t){for(this.status=h.REJECTED;this.queue&&this.queue.length;){var e=this.queue.shift();e[1].reject(new Error("Target of the call was rejected and callcannot be sent."))}return this.queue=null,t}function o(){for(;this.queue&&this.queue.length;){var t=this.queue.shift(),e=t[0],r=t[1];e.target=this.link.id,this._callRequestHandler(e,r)}this.queue=null}function i(e,r,n){var o=null;if(!this.hasRequestHandler(e))throw new Error('Request handler of type "'+e+'" is not registered.');var i=t.createRequestPackage(e,r,n,this.id),s=this._applyRequest(i,d());return o=D.create(s,this._requestHandlers)}function a(t,e){this.queue.push([t,e])}function p(t,e){var r=e.promise;switch(this.status){case h.PENDING:this._addToQueue(t,e);break;case h.REJECTED:r=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case h.DESTROYED:r=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case h.RESOLVED:this._callRequestHandler(t,e)}return r}function f(t,e){var r=O.lookupForPending(t.value),n=this._requestHandlers[t.type];r.length?Promise.all(r).then(function(){n(t,e)}):n(t,e)}function E(t){return this._requestHandlers.hasOwnProperty(t)&&"function"==typeof this._requestHandlers[t]}function y(){return this.status===h.PENDING||this.status===h.RESOLVED}function v(){return this.status===h.RESOLVED&&this.link.id}function R(){var t=null;return this.canBeDestroyed()?(_status=h.DESTROYED,t=this.sendRequest(c.DESTROY_TARGET)):t=Promise.reject(),t}function g(){var t=this.promise.then.apply(this.promise,arguments);return t&&(this.hadChildPromises=!0),t}function _(){var t=this.promise["catch"].apply(this.promise,arguments);return t&&(this.hadChildPromises=!0),t}function T(){var t={};return t[l]={id:this.link.id,type:this.link.type,poolId:this.link.poolId},t}function S(t,e){var r=t.temporary;return"boolean"!=typeof r&&(r="function"===s(e)?t.queue&&1===t.queue.length&&t.queue[0][0].type==c.CALL&&!t.hadChildPromises:t.queue&&1===t.queue.length&&!t.hadChildPromises),r}function P(t,e,r,n){return{type:t,cmd:e,value:r,target:n}}return t.prototype._resolveHandler=e,t.prototype._rejectHandler=r,t.prototype.hasRequestHandler=E,t.prototype._sendQueue=o,t.prototype.sendRequest=i,t.prototype._addToQueue=a,t.prototype._applyRequest=p,t.prototype._callRequestHandler=f,t.prototype.isActive=y,t.prototype.canBeDestroyed=v,t.prototype.destroy=R,t.prototype.then=g,t.prototype["catch"]=_,t.prototype.toJSON=T,t.isTemporary=S,t.createRequestPackage=P,t}(),D=function(){function t(t,e){t!==f&&(Object.defineProperty(this,p,{value:new R(t,e)}),Object.defineProperties(this,{id:{get:function(){return _link.id},configurable:!0},target:{get:function(){return this}},targetType:{get:function(){return _link.type},configurable:!0},poolId:{get:function(){return _link.poolId},configurable:!0},temporary:{get:function(){return _temporary},set:function(t){this.isActive()&&(_temporary=Boolean(t),_status==h.RESOLVED&&_destroy())}},status:{get:function(){return _status},configurable:!0}}))}function e(){this[p].then.apply(this[p],arguments)}function r(){this[p]["catch"].apply(this[p],arguments)}function n(t){return t[p].isActive()}function o(t){return t[p].canBeDestroyed()}function i(t){return t[p].destroy()}function s(t){return t[p].toJSON()}function u(t){function e(t){return a(t)&&r.push(t),t}var r=[];return"object"==typeof t&&null!==t&&(a(t)?r.push(t):t instanceof Array?convertArrayTo(t,e):t.constructor===Object&&convertHashTo(t,e)),r}function a(e){return e instanceof t&&c(e)==h.PENDING}function c(t){return t[p].status}function l(e,r){return new t(e,r)}var f={};return t.prototype.then=e,t.prototype["catch"]=r,t.isActive=n,t.canBeDestroyed=o,t.destroy=i,t.toJSON=s,t.lookupForPending=u,t.isPending=a,t.getStatus=c,t.create=l,t}(),g=function(){function t(){Object.defineProperties(this,{poolRegistry:{value:v},pool:{value:v.createPool()},resourceConverter:{value:O},IConvertible:{value:e}})}function r(t){return this.resourceConverter.parse(t)}function n(t){return this.resourceConverter.toJSON(t)}return t.prototype.parse=r,t.prototype.toJSON=n,new t}();return g});
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.DataAccessInterface=t()}(this,function(){function e(){return new y}function t(){return"function"==typeof Proxy}function r(){}function n(e,t){t=t||ResourcePoolRegistry.defaultResourcePool;var n=null;return e instanceof b?n=e.toJSON():"object"==typeof e[h]?n=_.toJSON(e):e instanceof r||"function"==typeof e?n=t.set(e).toJSON():u(e)&&(n=e),n}function o(e){var t=n(e);return t?t[p]:null}function i(e){var t=null;return"object"==typeof e[h]?t=e[h].id:u(e)&&(t=e[p].id),t}function s(e){var t=null;return"object"==typeof e[h]?t=e[h].poolId:u(e)&&(t=e[p].poolId),t}function u(e){return e instanceof b||e instanceof _||e&&("object"==typeof e[h]||"object"==typeof e[p])}function a(e){return u(e)||"function"==typeof e||e instanceof r}function c(e,t){return function(r,n,o){var i=v.create(e,r,t,n);return o instanceof Array?o.push(i):o&&(o[t]=i),i}}var l=function(){var e=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function r(){return o}function n(){o=!0}var o=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=n,this.isDefaultPrevented=r}return t.prototype.toJSON=e,t}(),t=function(){function e(e,t,r){var n=i(e,r,this._listeners);n.indexOf(t)<0&&n.push(t)}function t(e){var t=!1,r=s(e,this._listeners);if(r)for(var n in r)if(r.hasOwnProperty(n)){t=!0;break}return t}function r(e,t){var r=s(e,this._listeners);if(r)for(var n=Object.getOwnPropertyNames(r),o=n.length,i=0;o>i;i++){var u=n[i],a=r[u],c=a.indexOf(t);c>=0&&(a.splice(c,1),a.length||delete r[u])}}function n(e){delete this._listeners[e]}function o(e,t){function r(){o=!0}function n(){i=!0}var o=!1,i=!1;e.stopPropagation=r,e.stopImmediatePropagation=n;var u=s(e.type,this._listeners);if(u)for(var a=Object.getOwnPropertyNames(u).sort(function(e,t){return e-t}),c=a.length,l=0;c>l&&!o;l++)for(var f=u[a[l]],h=f.length,p=0;h>p&&!i;p++){var d=f[p];d.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function i(e,t,r){var n=s(e,r,Object);return s(parseInt(t),n,Array)}function s(e,t,r){var n=null;return t.hasOwnProperty(e)?n=t[e]:r&&(n=t[e]=new r),n}function u(){this._listeners={}}return u.prototype.add=e,u.prototype.has=t,u.prototype.remove=r,u.prototype.removeAll=n,u.prototype.call=o,u}(),r={},n=function(){function n(e){e!==r&&(Object.defineProperty(this,p,{value:new t}),Object.defineProperty(this,d,{value:e}))}function o(e,t,r){this[p].add(e,t,-r||0)}function i(e){return this[p].has(e)}function s(e,t){this[p].remove(e,t)}function u(e){this[p].removeAll(e)}function a(e,t){var r=n.getEvent(e,t);this[d]&&(r=this[d].call(this,r)),this[p].call(r)}function c(e){return"object"==typeof e&&null!==e}function l(e,t){var r=e;return n.isObject(e)||(r=new n.Event(String(e),t)),r}function f(e){return new n(e)}function h(){return new n(r)}var p=Symbol("event.dispatcher::listeners"),d=Symbol("event.dispatcher::preprocessor");return n.prototype.addEventListener=o,n.prototype.hasEventListener=i,n.prototype.removeEventListener=s,n.prototype.removeAllEventListeners=u,n.prototype.dispatchEvent=a,n.isObject=c,n.getEvent=l,n.create=f,n.createNoInitPrototype=h,n.Event=e,n}();return n}(),f=Object.freeze({PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"}),h=Symbol("request.target:internals"),p="resource::data",d=function(){var e="DA/"+String(Date.now())+"/",t=0;return function(){return e+String(++t)+"/"+String(Date.now())}}(),y=function(){function e(){this._status=f.PENDING,this.promise=new Promise(function(e,t){this._resolveHandler=e,this._rejectHandler=t}.bind(this)),Object.defineProperties(this,{status:{get:t}})}function t(){return this._status}function r(){var e=this._resolveHandler.apply(null,arguments);return this._status=f.RESOLVED,e}function n(){var e=this._rejectHandler.apply(null,arguments);return this._status=f.REJECTED,e}return e.prototype.resolve=r,e.prototype.reject=n,e}(),v=function(){function e(){return!1}function t(t,r,n,o){this.name=void 0!==n?n:t,this.type=t,this.handle=r,this.isTemporary=o||e}function r(e,r,n,o){var i=new t(e,r,n,o);return Object.freeze(i)}return t.create=r,t}(),E=Object.freeze({DESTROY:"::destroy.resource"}),g=function(){function e(){return[u.GET,u.SET,u.APPLY,u.DELETE_PROPERTY]}function t(){return[u.GET,u.SET,u.APPLY]}function r(e,t,r){var n,o,i,s,u=g.list,a=u.length;r=r||{};for(var c=0;a>c;c++)o=u[c],n=e[o],i=g.fields[o],n instanceof Function&&(s=v.create(o,n,i,t),r instanceof Array?r.push(s):r&&(r[i]=s));return r}var n=Symbol("proxy.commands::get"),o=Symbol("proxy.commands::set"),i=Symbol("proxy.commands::apply"),s=Symbol("proxy.commands::deleteProperty"),u={GET:"get",SET:"set",APPLY:"apply",DELETE_PROPERTY:"deleteProperty"};return u.fields=Object.freeze({get:n,set:o,apply:i,deleteProperty:s}),Object.defineProperties(u,{list:{get:e},required:{get:t}}),u.createGETDescriptor=c(u.GET,u.fields.get),u.createSETDescriptor=c(u.SET,u.fields.set),u.createAPPLYDescriptor=c(u.APPLY,u.fields.apply),u.createDescriptors=r,Object.freeze(u)}(),m=Object.freeze({names:Object.freeze({then:!0,"catch":!0}),commands:Object.freeze({"::destroy.resource":!0})}),b=function(){function e(e,u,a,c){Object.defineProperty(this,h,{value:{active:!0,pool:e,poolId:e?e.id:null,resource:u,type:a,id:c}}),Object.defineProperty(this,p,{get:t}),Object.defineProperties(this,{active:{get:r},poolId:{get:n},resource:{get:o},type:{get:i},id:{get:s}})}function t(){return this.toJSON()}function r(){return Boolean(this[h].active)}function n(){return this[h].poolId}function o(){return this[h].resource}function i(){return this[h].type||typeof this[h].resource}function s(){return this[h].id}function u(){var e={};return e[p]={id:this[h].id,type:this.type,poolId:this.poolId},e}function a(){var e=this[h].id,t=this[h].pool;if(this[h].active){this[h].active=!1,t.remove(e);for(var r in this[h])delete this[h][r]}}function c(t,r,n,o){return new e(t,r,n,o||d())}return e.prototype.toJSON=u,e.prototype.destroy=a,e.create=c,e}(),P=function(){function e(e,t,r,n){this[y]=e,this[E]=r,this[v]=t,l.apply(this),n&&n.setConverter(this)}function t(e){var t;return t=a(e)?n(e,this[E]):"function"==typeof e.toJSON?e.toJSON():e,t!==e&&this.hasEventListener(g.RESOURCE_CONVERTED)&&this.dispatchEvent(g.RESOURCE_CONVERTED,{data:e,result:t}),t}function r(e){var t,r=e;if(u(e))if(t=s(e),this[v].isRegistered(t)){var n=this[v].get(t).get(i(e));n&&(r=n.resource)}else r=this[y].create(Promise.resolve(e));return r!==e&&this.hasEventListener(g.RESOURCE_CREATED)&&this.dispatchEvent(g.RESOURCE_CREATED,{data:e,result:r}),r}function o(e,t){for(var r=[],n=e.length,o=0;n>o;o++)r[o]=t.call(this,e[o]);return r}function c(e,t){var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]=t.call(this,e[n]));return r}function f(e){var t=e;return void 0!==e&&null!==e&&(a(e)?t=this.resourceToObject(e):e instanceof Array?t=this.lookupArray(e,this.resourceToObject):e.constructor===Object&&(t=this.lookupObject(e,this.resourceToObject))),t}function h(e){var t=e;return void 0!==e&&null!==e&&(u(e)?t=this.objectToResource(e):e instanceof Array?t=this.lookupArray(e,this.objectToResource):e.constructor===Object&&(t=this.lookupObject(e,this.objectToResource))),t}function p(e){function t(e){return _.isPending(e)&&r.push(e),e}var r=[];return"object"==typeof e&&null!==e&&(_.isPending(e)?r.push(e):e instanceof Array?this.lookupArray(e,t):e.constructor===Object&&this.lookupObject(e,t)),r}function d(t,r,n,o){return new e(t,r,n,o)}var y=Symbol("resource.converter::factory"),v=Symbol("resource.converter::resourcePoolRegistry"),E=Symbol("resource.converter::resourcePool"),g=Object.freeze({RESOURCE_CREATED:"resourceCreated",RESOURCE_CONVERTED:"resourceConverted"});return e.prototype=l.createNoInitPrototype(),e.prototype.constructor=e,e.prototype.toJSON=f,e.prototype.parse=h,e.prototype.lookupArray=o,e.prototype.lookupObject=c,e.prototype.lookupForPending=p,e.prototype.resourceToObject=t,e.prototype.objectToResource=r,e.create=d,e.Events=g,e}(),O=function(){function e(r){function n(e){f=e}function o(t){p={},e.filterHandlers(t,p),h=Object.getOwnPropertyNames(p).concat(Object.getOwnPropertySymbols(p)),r&&e.areProxyHandlersAvailable(p,!0)}function i(e){return p.hasOwnProperty(e)}function s(){return p}function u(){return h.slice()}function a(e){return p[e]||null}function c(e,t,r,n){var o=f?f.lookupForPending(r.value):null;o&&o.length?Promise.all(o).then(function(){l(e,t,r,n)}):l(e,t,r,n)}function l(e,t,r,n){var o=a(t);if(!(o instanceof v))throw new Error('Command descriptor for "'+t+'" was not found.');o.handle(e,r,n)}var f,h=[],p={};r=Boolean(r),Object.defineProperties(this,{proxyEnabled:{value:r},available:{get:function(){return Boolean(h.length)}}}),this.setConverter=n,this.setHandlers=o,this.hasHandler=i,this.getHandlers=s,this.getHandlerNames=u,this.getHandler=a,this.handle=c,this[Symbol.iterator]=function(){return new t(this.getHandlers(),this.getHandlerNames())}}function t(e,t){function r(){var r;return r=++o>=n?{done:!0}:{value:e[t[o]],done:!1}}var n=t.length,o=-1;this.next=r,this[Symbol.iterator]=function(){return this}.bind(this)}function r(t){return new e(t)}function n(e,t){for(var r=!0,n=g.required,o=n.length,i=0;o>i;i++){var s=n[i];if(!(g.fields[s]in e)&&(r=!1,t))throw new Error('For Proxy interface, handler "'+s+'" should be set.')}return r}var o=Object.freeze({HANDLERS_UPDATED:"handlersUpdated"}),i=function(){function e(e,t){for(var n=e.length,o=0;n>o;o++){var i=e[o];i instanceof v&&r(i,t)}}function t(e,t){if(e)for(var n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e)),o=n.length,i=0;o>i;i++){var s=n[i],u=e[s];"function"==typeof u&&(u=v.create(s,u)),u instanceof v&&r(u,t)}}function r(e,t){var r=e.name,n=e.type;if(n in m.commands)throw new Error('Command "'+n+'" is reserved and cannot be used in descriptor.');if(r in m.names)throw new Error('Name "'+r+'" is reserved and cannot be used in descriptor.');if(t.hasOwnProperty(r)&&t[r]instanceof v)throw new Error('Field names should be unique, "'+String(r)+'" field has duplicates.');t[r]=e}function n(r,n){r instanceof Array?e(r,n):t(r,n)}return n}();return e.filterHandlers=i,e.areProxyHandlersAvailable=n,e.create=r,e.Events=o,e}(),R=function(){function e(e,t){function r(t,r,n){function i(o,i){var s,u,a=!1;return this[h]?(u=this[h].sendRequest(t,r,o,i),u?u.then(function(e){_.setTemporary(s,Boolean(n(s,e,o,i)))}):(u=Promise.reject(new Error("Initial request failed and didn't result in promise.")),a=!0)):(u=Promise.reject(new Error("Target object is not a resource, so cannot be used for calls.")),a=!0),s=e.create(u),a||this[h].registerChild(s),s}return o.has(t)||o.set(t,i),o.get(t)}function n(e){if(t.available){for(var n,o=t[Symbol.iterator]();!(n=o.next()).done;){var i=n.value;e[i.name]=r(i.name,i.type,i.isTemporary)}return e}}var o=new Map;this.apply=n}function t(t,r){return new e(t,r)}return e.create=t,e}(),j=Symbol("request.factory::decorator"),w=Symbol("request.factory::handlers"),S=function(){function e(e){e!==o&&(this[w]=e,this[j]=R.create(this,e))}function t(e){var t=_.create(e,this[w]);return this[w].available&&this[j].apply(t),t}function r(t){return new e(t)}function n(){return new e(o)}var o={};return e.prototype.create=t,e.create=r,e.createNoInitProtoype=n,e}(),D=function(){function e(e,t){function r(){}return r.target=e,new Proxy(r,t)}function t(e,t,r){var n,o=e.target;return n=t in o||t in p||"symbol"==typeof t?o[t]=r:o[g.fields.set](t,r)}function r(e,t){return e.target.hasOwnProperty(t)}function n(e,t){var r=!1,n=e.target;return g.fields.deleteProperty in n&&(n[g.fields.deleteProperty](t),r=!0),r}function o(){return Object.getOwnPropertyNames(p)}function i(){return Object.getOwnPropertyNames(p)}function s(e,t){var r;return r=p.hasOwnProperty(t)?Object.getOwnPropertyDescriptor(e,t):Object.getOwnPropertyDescriptor(e.target,t)}function u(){function u(t,r){var n,o=t.target;return n=r in o||r in p||"symbol"==typeof r?o[r]:e(o[g.fields.get](r),c)}function a(t,r,n){return e(t.target[g.fields.apply](null,n),c)}var c;return c={get:u,apply:a,set:t,has:r,deleteProperty:n,ownKeys:o,enumerate:i,getOwnPropertyDescriptor:s}}function a(e){this[w]=e,this[h]=S.create(e)}function c(t){var r=this[h].create(t);return this[w].available&&(r=e(r,d)),r}function l(t){return e(t,d)}function f(e,t){return new a(e,t)}var h=Symbol("request.proxy.factory::factory"),p={arguments:!0,caller:!0,prototype:!0},d=u();return a.prototype=S.createNoInitProtoype(),a.prototype.constructor=a,a.prototype.create=c,a.create=f,a.applyProxy=l,a}(),T=function(){function t(t,o,u){this.requestHandlers=u,this.requestTarget=t,this.link={},this.temporary,this.hadChildPromises=!1,this.status=f.PENDING,this.queue=[],this.children=[],this._deferred=e(),this.promise=this._deferred.promise,Object.defineProperties(this,{poolId:{get:r},type:{get:n},id:{get:i}}),o.then(s.bind(this),a.bind(this))}function r(){return this.link.poolId||null}function n(){return this.link.type||null}function i(){return this.link.id||null}function s(e){this.status=f.RESOLVED,u(e)?(this.link=o(e),e={target:this.requestTarget},this._sendQueue(),this.temporary&&this.destroy()):this._rejectQueue("Target of the call is not a resource and call cannot be sent."),this._deferred.resolve(e),delete this._deferred}function a(e){this.status=f.REJECTED,this._rejectQueue("Target of the call was rejected and call cannot be sent."),this._deferred.reject(e),delete this._deferred}function c(){for(;this.queue&&this.queue.length;){var e=this.queue.shift(),t=e[0],r=e[1],n=e[2];r.target=this.link.id,this._handleRequest(t,r,n)}this.queue=null}function l(e){for(var t=new Error(e||"This request was rejected before sending.");this.queue&&this.queue.length;){var r=this.queue.shift();r[2].reject(t)}this.queue=null}function h(r,n,o,i){var s=null;if(!this.requestHandlers.hasHandler(r))throw new Error('Request handler of type "'+n+'" is not registered.');var u=t.createRequestPackage(n,o,i,this.id);return s=this._applyRequest(r,u,e())}function d(e,t,r){this.queue.push([e,t,r])}function y(e,t,r){var n=r.promise;switch(this.status){case f.PENDING:this._addToQueue(e,t,r);break;case f.REJECTED:n=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case f.DESTROYED:n=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case f.RESOLVED:this._handleRequest(e,t,r)}return n}function v(e,t,r){this.requestHandlers.handle(this.requestTarget,e,t,r)}function g(e){var t=m.bind(this,e),r=_.getRawPromise(e);this.children.push(e),r.then(t,t)}function m(e){if(this.children){var t=this.children.indexOf(e);t>=0&&this.children.splice(t,1)}}function b(){return this.status===f.PENDING||this.status===f.RESOLVED}function P(){return this.status===f.RESOLVED||this.status===f.REJECTED}function O(){var e=null;return this.canBeDestroyed()?(e=this.status===f.RESOLVED?this.sendRequest(E.DESTROY,E.DESTROY):Promise.resolve(),this.status=f.DESTROYED):e=Promise.reject(new Error("Invalid or already destroyed target.")),e}function R(){var e=this.promise.then.apply(this.promise,arguments);return e&&(this.hadChildPromises=!0),e}function j(){var e=this.promise["catch"].apply(this.promise,arguments);return e&&(this.hadChildPromises=!0),e}function w(){var e={};return e[p]={id:this.link.id,type:this.link.type,poolId:this.link.poolId},e}function S(e,t,r,n){return{type:e,cmd:t,value:r,target:n}}return t.prototype._sendQueue=c,t.prototype._rejectQueue=l,t.prototype.sendRequest=h,t.prototype._addToQueue=d,t.prototype._applyRequest=y,t.prototype._handleRequest=v,t.prototype.registerChild=g,t.prototype.isActive=b,t.prototype.canBeDestroyed=P,t.prototype.destroy=O,t.prototype.then=R,t.prototype["catch"]=j,t.prototype.toJSON=w,t.createRequestPackage=S,t}(),_=function(){function e(e,r){var n;Object.defineProperty(this,h,{value:new T(this,e,r),configurable:!0}),n=t.bind(this,e),e.then(n,n)}function t(e,t){u(t)||(this[O]=e,delete this[h])}function r(){var e=this[h]||this[O];e.then.apply(e,arguments)}function n(){var e=this[h]||this[O];e["catch"].apply(e,arguments)}function o(e){return e&&e[h]?e[h].isActive():!1}function i(e){return e&&e[h]?e[h].canBeDestroyed():!1}function s(e){return e&&e[h]?e[h].destroy():null}function a(e){return e&&e[h]?e[h].toJSON():null}function c(e){return d(e)==f.PENDING}function l(e){return e&&e[h]&&e[h].temporary}function p(e,t){e&&e[h]&&(e[h].temporary=Boolean(t))}function d(e){return e&&e[h]?e[h].status:null}function y(e){return e&&e[h]?e[h].queue.length:0}function v(e){var t,r=[],n=e&&e[h]?e[h].queue:null;if(n){t=n.length;for(var o=0;t>o;o++)r.push(n[o][0].type)}return r}function E(e){return Boolean(e&&e[h]&&e[h].hadChildPromises)}function g(e){return e&&e[h]?e[h].promise:null}function m(e){var t=e&&e[h]?e[h].children:null;return t?t.slice():[]}function b(e){var t=e&&e[h]?e[h].children:null;return t?t.length:0}function P(t,r){return new e(t,r)}var O=Symbol("request.target::promise");return e.prototype.then=r,e.prototype["catch"]=n,e.isActive=o,e.canBeDestroyed=i,e.destroy=s,e.toJSON=a,e.isPending=c,e.isTemporary=l,e.setTemporary=p,e.getStatus=d,e.getQueueLength=y,e.getQueueCommands=v,e.hadChildPromises=E,e.getRawPromise=g,e.getChildren=m,e.getChildrenCount=b,e.create=P,e}(),N=function(){function n(e,r,n,o){function i(e){o.removeEventListener(ResourcePool.Events.POOL_DESTROYED,i),o=n.createPool(),o.addEventListener(ResourcePool.Events.POOL_DESTROYED,i)}if(r&&!t())throw new Error("Proxies are not available in this environment");var s=O.create(r),u=(r?D:S).create(s);n=n||ResourcePoolRegistry.create(),o?n.register(o):o=void 0!==o?n.createPool():ResourcePoolRegistry.defaultResourcePool,Object.defineProperties(this,{poolRegistry:{value:n},pool:{get:function(){return o}},resourceConverter:{value:P.create(u,n,o,s)},factory:{value:u},proxyEnabled:{get:function(){return s.proxyEnabled}}}),e.setHandlers(e),o.addEventListener(ResourcePool.Events.POOL_DESTROYED,i)}function o(e){return this.resourceConverter.parse(e)}function i(e){return this.resourceConverter.toJSON(e)}function s(e,t,r,o){return new n(e,t,r,o)}return n.prototype.parse=o,n.prototype.toJSON=i,n.create=s,n.createDeferred=e,n.IConvertible=r,n.RequestTarget=_,n.Deferred=y,n.Reserved=m,n.RequestTargetCommands=E,n.CommandDescriptor=v,n.ProxyCommands=g,n.ResourcePool=ResourcePool,n.ResourcePoolRegistry=ResourcePoolRegistry,n.ResourceConverter=P,n}();return N});
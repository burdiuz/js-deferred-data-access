!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.DataAccessInterface=t()}(this,function(){function e(){return"function"==typeof Proxy}function t(){}function r(e,r){r=r||ResourcePoolRegistry.defaultResourcePool;var n=null;return e instanceof E?n=e.toJSON():"object"==typeof e[p]?n=T.toJSON(e):e instanceof t||"function"==typeof e?n=r.set(e).toJSON():s(e)&&(n=e),n}function n(e){var t=r(e);return t?t[d]:null}function o(e){var t=null;return"object"==typeof e[p]?t=e[p].id:s(e)&&(t=e[d].id),t}function i(e){var t=null;return"object"==typeof e[p]?t=e[p].poolId:s(e)&&(t=e[d].poolId),t}function s(e){return e instanceof E||e instanceof T||e&&("object"==typeof e[p]||"object"==typeof e[d])}function u(e){return s(e)||"function"==typeof e||e instanceof t}var a=function(){var e=function(){function e(){return{type:this.type,data:this.data}}function t(e,t){function r(){return o}function n(){o=!0}var o=!1;Object.defineProperties(this,{type:{value:e,enumerable:!0},data:{value:t||null,enumerable:!0}}),this.preventDefault=n,this.isDefaultPrevented=r}return t.prototype.toJSON=e,t}(),t=function(){function e(e,t,r){var n=i(e,r,this._listeners);n.indexOf(t)<0&&n.push(t)}function t(e){var t=!1,r=s(e,this._listeners);if(r)for(var n in r)if(r.hasOwnProperty(n)){t=!0;break}return t}function r(e,t){var r=s(e,this._listeners);if(r)for(var n=Object.getOwnPropertyNames(r),o=n.length,i=0;o>i;i++){var u=n[i],a=r[u],c=a.indexOf(t);c>=0&&(a.splice(c,1),a.length||delete r[u])}}function n(e){delete this._listeners[e]}function o(e,t){function r(){o=!0}function n(){i=!0}var o=!1,i=!1;e.stopPropagation=r,e.stopImmediatePropagation=n;var u=s(e.type,this._listeners);if(u)for(var a=Object.getOwnPropertyNames(u).sort(function(e,t){return e-t}),c=a.length,l=0;c>l&&!o;l++)for(var h=u[a[l]],f=h.length,p=0;f>p&&!i;p++){var d=h[p];d.call(t,e)}delete e.stopPropagation,delete e.stopImmediatePropagation}function i(e,t,r){var n=s(e,r,Object);return s(parseInt(t),n,Array)}function s(e,t,r){var n=null;return t.hasOwnProperty(e)?n=t[e]:r&&(n=t[e]=new r),n}function u(){this._listeners={}}return u.prototype.add=e,u.prototype.has=t,u.prototype.remove=r,u.prototype.removeAll=n,u.prototype.call=o,u}(),r={},n=function(){function n(e){e!==r&&(Object.defineProperty(this,p,{value:new t}),Object.defineProperty(this,d,{value:e}))}function o(e,t,r){this[p].add(e,t,-r||0)}function i(e){return this[p].has(e)}function s(e,t){this[p].remove(e,t)}function u(e){this[p].removeAll(e)}function a(e,t){var r=n.getEvent(e,t);this[d]&&(r=this[d].call(this,r)),this[p].call(r)}function c(e){return"object"==typeof e&&null!==e}function l(e,t){var r=e;return n.isObject(e)||(r=new n.Event(String(e),t)),r}function h(e){return new n(e)}function f(){return new n(r)}var p=Symbol("event.dispatcher::listeners"),d=Symbol("event.dispatcher::preprocessor");return n.prototype.addEventListener=o,n.prototype.hasEventListener=i,n.prototype.removeEventListener=s,n.prototype.removeAllEventListeners=u,n.prototype.dispatchEvent=a,n.isObject=c,n.getEvent=l,n.create=h,n.createNoInitPrototype=f,n.Event=e,n}();return n}(),c=Object.freeze({THEN:"then",CATCH:"catch",DESTROY_TARGET:"::destroy.resource"}),l=Object.freeze({PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"}),h=Object.freeze({DESTROY:c.DESTROY_TARGET}),f=Object.freeze({GET:"get",SET:"set",APPLY:"apply"}),p=Symbol("request.target:internals"),d="resource::data",y=function(){var e="DA/"+String(Date.now())+"/",t=0;return function(){return e+String(++t)+"/"+String(Date.now())}}(),v=function(){function e(){this._status=l.PENDING,this.promise=new Promise(function(e,t){this._resolveHandler=e,this._rejectHandler=t}.bind(this)),Object.defineProperties(this,{status:{get:t}})}function t(){return this._status}function r(){var e=this._resolveHandler.apply(null,arguments);return this._status=l.RESOLVED,e}function n(){var e=this._rejectHandler.apply(null,arguments);return this._status=l.REJECTED,e}function o(){return new e}return e.prototype.resolve=r,e.prototype.reject=n,o}(),E=function(){function e(e,u,a,c){Object.defineProperty(this,p,{value:{active:!0,pool:e,poolId:e?e.id:null,resource:u,type:a,id:c}}),Object.defineProperty(this,d,{get:t}),Object.defineProperties(this,{active:{get:r},poolId:{get:n},resource:{get:o},type:{get:i},id:{get:s}})}function t(){return this.toJSON()}function r(){return Boolean(this[p].active)}function n(){return this[p].poolId}function o(){return this[p].resource}function i(){return this[p].type||typeof this[p].resource}function s(){return this[p].id}function u(){var e={};return e[d]={id:this[p].id,type:this.type,poolId:this.poolId},e}function a(){var e=this[p].id,t=this[p].pool;if(this[p].active){this[p].active=!1,t.remove(e);for(var r in this[p])delete this[p][r]}}function c(t,r,n,o){return new e(t,r,n,o||y())}return e.prototype.toJSON=u,e.prototype.destroy=a,e.create=c,e}(),O=function(){function e(e,t,r){this[y]=e,this[v]=t,a.apply(this),r&&r.setConverter(this)}function t(e){var t;return u(e)?t=r(e,this[v]):"function"==typeof e.toJSON&&(t=e.toJSON()),t!==e&&this.hasEventListener(E.RESOURCE_CONVERTED)&&this.dispatchEvent(E.RESOURCE_CONVERTED,{data:e,result:t}),t}function n(e){var t,r=i(e);return ResourcePoolRegistry.isRegistered(r)?(e=ResourcePoolRegistry.get(r).get(o(e)),e&&(t=e.resource)):t=this[y].create(Promise.resolve(e)),t!==e&&this.hasEventListener(E.RESOURCE_CREATED)&&this.dispatchEvent(E.RESOURCE_CREATED,{data:e,result:t}),t}function c(e,t){for(var r=[],n=e.length,o=0;n>o;o++)r[o]=t.call(this,e[o]);return r}function l(e,t){var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]=t.call(this,e[n]));return r}function h(e){var t=e;return void 0!==e&&null!==e&&(u(e)?t=this.resourceToObject(e):e instanceof Array?t=this.lookupArray(e,this.resourceToObject):e.constructor===Object&&(t=this.lookupObject(e,this.resourceToObject))),t}function f(e){var t=e;return void 0!==e&&null!==e&&(s(e)?t=this.objectToResource(e):e instanceof Array?t=this.lookupArray(e,this.objectToResource):e.constructor===Object&&(t=this.lookupObject(e,this.objectToResource))),t}function p(e){function t(e){return T.isPending(e)&&r.push(e),e}var r=[];return"object"==typeof e&&null!==e&&(T.isPending(e)?r.push(e):e instanceof Array?this.lookupArray(e,t):e.constructor===Object&&this.lookupObject(e,t)),r}function d(t,r,n){return new e(t,r,n)}var y=Symbol("resource.converter::factory"),v=Symbol("resource.converter::resourcePool"),E=Object.freeze({RESOURCE_CREATED:"resourceCreated",RESOURCE_CONVERTED:"resourceConverted"});return e.prototype=a.createNoInitPrototype(),e.prototype.constructor=e,e.prototype.toJSON=h,e.prototype.parse=f,e.prototype.lookupArray=c,e.prototype.lookupObject=l,e.prototype.lookupForPending=p,e.prototype.resourceToObject=t,e.prototype.objectToResource=n,e.create=d,e.Events=E,e}(),b=function(){function e(){return!1}function t(r){function n(e){l=e}function o(e){var n=[];e=t.filterHandlers(e,n),r&&t.areProxyHandlersAvailable(e,!0),p=Boolean(n.length),f=e}function i(e){return f.hasOwnProperty(e)}function s(){return f}function u(e){return f[e]||null}function a(e,t,r){var n=l?l.lookupForPending(t.value):null;n&&n.length?Promise.all(n).then(function(){c(e,t.type,t,r)}):c(e,t.type,t,r)}function c(e,t,r,n){var o=u(t);"function"==typeof o&&o(e,r,n)}var l,h=e,f={},p=!1;Object.defineProperties(this,{isTemporary:{get:function(){return h},set:function(t){h="function"==typeof t?t:e}},available:{get:function(){return p}}}),this.setConverter=n,this.setHandlers=o,this.hasHandler=i,this.getHandlers=s,this.getHandler=u,this.handle=a}function r(e,t){var r={};for(var n in e)if(e.hasOwnProperty(n)&&"function"==typeof e[n]){if(n in c)throw new Error('Name "'+n+'" is reserved and cannot be used as command handler.');t.push(n),r[n]=e[n]}return r}function n(e){return new t(e)}function o(e,t){var r=!0;for(var n in f)if(f.hasOwnProperty(n)&&!(f[n]in e)&&(r=!1,t))throw new Error('For Proxy interface, handler "'+n+'" should be set.');return r}var i=Object.freeze({HANDLERS_UPDATED:"handlersUpdated"});return t.filterHandlers=r,t.areProxyHandlersAvailable=o,t.create=n,t.Events=i,t}(),g=function(){function e(e,t){function r(t){return o.hasOwnProperty(t)||(o[t]=function(t){function r(r,n){var o=this[p].sendRequest(t,r,n);return e.create(o||Promise.reject("Initial request failed and didn't result in promise."))}return r}(t)),o[t]}function n(e){var n=t.getHandlers();for(var o in n)n.hasOwnProperty(o)&&(e[o]=r(o));return e}var o={};this.decorate=n}function t(t){return new e(t)}return e.create=t,e}(),P=Symbol("request.factory::decorator"),R=Symbol("request.factory::handlers"),m=function(){function e(e){e!==o&&(this[R]=e,this[P]=new g(this,e))}function t(e){var t=T.create(e,this[R]);return this[R].available&&this[P].decorate(t),t}function r(t){return new e(t)}function n(){return new e(o)}var o={};return e.prototype.create=t,e.create=r,e.createNoInitProtoype=n,e}(),j=function(){function e(e,n,i){this._requestHandlers=i,this._requestTarget=e,this.link={},this.temporary,this.hadChildPromises=!1,this.status=l.PENDING,this.queue=[],this.promise=n.then(this._resolveHandler.bind(this),this._rejectHandler.bind(this)),Object.defineProperties(this,{poolId:{get:t},type:{get:r},id:{get:o}})}function t(){return this.link.poolId||null}function r(){return this.link.type||null}function o(){return this.link.id||null}function i(e){return this.status=l.RESOLVED,s(e)&&(this.link=n(e),this.temporary=this._requestHandlers.isTemporary(this._requestTarget),this.temporary&&this.queue[this.queue.length-1][1].promise.then(this.destroy.bind(this),this.destroy.bind(this)),e={target:this}),this._sendQueue(),e}function u(e){for(this.status=l.REJECTED;this.queue&&this.queue.length;){var t=this.queue.shift();t[1].reject(new Error("Target of the call was rejected and call cannot be sent."))}return this.queue=null,e}function a(){for(;this.queue&&this.queue.length;){var e=this.queue.shift(),t=e[0],r=e[1];t.target=this.link.id,this._requestHandlers.handle(this._requestTarget,t,r)}this.queue=null}function h(t,r,n){var o=null;if(!this._requestHandlers.hasHandler(t))throw new Error('Request handler of type "'+t+'" is not registered.');var i=e.createRequestPackage(t,r,n,this.id);return o=this._applyRequest(i,v())}function f(e,t){this.queue.push([e,t])}function p(e,t){var r=t.promise;e.type;switch(this.status){case l.PENDING:this._addToQueue(e,t);break;case l.REJECTED:r=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case l.DESTROYED:r=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case l.RESOLVED:this._requestHandlers.handle(this._requestTarget,e,t)}return r}function y(){return this.status===l.PENDING||this.status===l.RESOLVED}function E(){return this.status===l.RESOLVED&&this.link.id}function O(){var e=null;return this.canBeDestroyed()?(this.status=l.DESTROYED,e=this.sendRequest(c.DESTROY_TARGET)):e=Promise.reject(),e}function b(){var e=this.promise.then.apply(this.promise,arguments);return e&&(this.hadChildPromises=!0),e}function g(){var e=this.promise["catch"].apply(this.promise,arguments);return e&&(this.hadChildPromises=!0),e}function P(){var e={};return e[d]={id:this.link.id,type:this.link.type,poolId:this.link.poolId},e}function R(e,t,r,n){return{type:e,cmd:t,value:r,target:n}}return e.prototype._resolveHandler=i,e.prototype._rejectHandler=u,e.prototype._sendQueue=a,e.prototype.sendRequest=h,e.prototype._addToQueue=f,e.prototype._applyRequest=p,e.prototype.isActive=y,e.prototype.canBeDestroyed=E,e.prototype.destroy=O,e.prototype.then=b,e.prototype["catch"]=g,e.prototype.toJSON=P,e.createRequestPackage=R,e}(),T=function(){function e(e,t){Object.defineProperty(this,p,{value:new j(this,e,t)})}function t(){this[p].then.apply(this[p],arguments)}function r(){this[p]["catch"].apply(this[p],arguments)}function n(e){return e[p].isActive()}function o(e){return e[p].canBeDestroyed()}function i(e){return e[p].destroy()}function s(e){return e[p].toJSON()}function u(t){return t instanceof e&&h(t)==l.PENDING}function a(e){return Boolean(e[p].temporary)}function c(e,t){e[p].temporary=Boolean(t)}function h(e){return e[p].status}function f(e){var t=e[p].queue;return t?t.length:0}function d(e){var t,r=[],n=e[p].queue;if(n){t=n.length;for(var o=0;t>o;o++)r.push(n[o][0].type)}return r}function y(e){return e[p].hadChildPromises}function v(t,r){return new e(t,r)}return e.prototype.then=t,e.prototype["catch"]=r,e.isActive=n,e.canBeDestroyed=o,e.destroy=i,e.toJSON=s,e.isPending=u,e.isTemporary=a,e.setTemporary=c,e.getStatus=h,e.getQueueLength=f,e.getQueueCommands=d,e.hadChildPromises=y,e.create=v,e}(),S=function(){function r(t){if(t&&!e())throw new Error("Proxies are not available in this environment");var r=b.create(t),n=(t?RequestProxyFactory:m).create(r),o=ResourcePoolRegistry.create(),i=ResourcePoolRegistry.defaultResourcePool;Object.defineProperties(this,{poolRegistry:{value:o},pool:{value:i},resourceConverter:{value:O.create(n,i,r)},factory:{value:n},proxyEnabled:{value:t}}),this.setHandlers=r.setHandlers}function n(e){return this.resourceConverter.parse(e)}function o(e){return this.resourceConverter.toJSON(e)}function i(e){return new r(e)}return r.prototype.parse=n,r.prototype.toJSON=o,r.create=i,r.IConvertible=t,r.RequestTarget=T,r.RequestTargetCommands=h,r.ProxyCommands=f,r.TargetPoolEvents=ResourcePool.Events,r.ResourceConverterEvents=O.Events,r}();return S});
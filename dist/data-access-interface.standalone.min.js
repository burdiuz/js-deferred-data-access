!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.DataAccessInterface=e()}(this,function(){function t(){}function e(e){var r;return e instanceof d?r=e.toJSON():e instanceof P?r=P.toJSON(e):e instanceof t||"function"==typeof e?r=_.pool.set(e).toJSON():i(e)&&(r=e),r}function r(t){var r=e(t);return r?r[p]:null}function n(t){var e;return t instanceof d||t instanceof P?e=t[h].id:i(t)&&(e=t[p].id),e}function o(t){var e;return i(t)&&(e=t[p].poolId),e}function i(t){return t instanceof d||t instanceof P||t&&"object"==typeof t[p]&&t[p]}function s(e){return i(e)||"function"==typeof e||e instanceof t}var u=function(){function t(t){return"object"==typeof t&&null!==t}function e(t){function r(t,e,r){a.add(t,e,-r||0)}function n(t){return a.has(t)}function i(t,e){a.remove(t,e)}function s(t){a.removeAll(t)}function u(r,n){var o=e.getEvent(r,n);t&&(o=t.call(this,o)),a.call(o)}var a=new o;this.addEventListener=r,this.hasEventListener=n,this.removeEventListener=i,this.removeAllEventListeners=s,this.dispatchEvent=u}function r(t,r){var n=t;return e.isObject(t)||(n=new e.Event(String(t),r)),n}var n=function(){function t(){return{type:this.type,data:this.data}}function e(t,e){function r(){return o}function n(){o=!0}var o=!1;Object.defineProperties(this,{type:{value:t,enumerable:!0},data:{value:e||null,enumerable:!0}}),this.preventDefault=n,this.isDefaultPrevented=r}return e.prototype.toJSON=t,e}(),o=function(){function t(t,e,r){var n=i(t,r,this._listeners);n.indexOf(e)<0&&n.push(e)}function e(t){var e=!1,r=s(t,this._listeners);if(r)for(var n in r)if(r.hasOwnProperty(n)){e=!0;break}return e}function r(t,e){var r=s(t,this._listeners);if(r)for(var n=Object.getOwnPropertyNames(r),o=n.length,i=0;o>i;i++){var u=n[i],a=r[u],c=a.indexOf(e);c>=0&&(a.splice(c,1),a.length||delete r[u])}}function n(t){delete this._listeners[t]}function o(t,e){function r(){o=!0}function n(){i=!0}var o=!1,i=!1;t.stopPropagation=r,t.stopImmediatePropagation=n;var u=s(t.type,this._listeners);if(u)for(var a=Object.getOwnPropertyNames(u).sort(function(t,e){return t-e}),c=a.length,h=0;c>h&&!o;h++)for(var p=u[a[h]],f=p.length,l=0;f>l&&!i;l++){var d=p[l];d.call(e,t)}delete t.stopPropagation,delete t.stopImmediatePropagation}function i(t,e,r){var n=s(t,r,Object);return s(parseInt(e),n,Array)}function s(t,e,r){var n=null;return e.hasOwnProperty(t)?n=e[t]:r&&(n=e[t]=new r),n}function u(){this._listeners={}}return u.prototype.add=t,u.prototype.has=e,u.prototype.remove=r,u.prototype.removeAll=n,u.prototype.call=o,u}();return e.isObject=t,e.getEvent=r,e.Event=n,e}(),a={THEN:"then",CATCH:"catch",DESTROY_TARGET:"::destroy.resource"},c={PENDING:"pending",RESOLVED:"resolved",REJECTED:"rejected",DESTROYED:"destroyed"},h=Symbol("request.target:internals"),p="resource::data",f=function(){var t="DA/"+String(Date.now())+"/",e=0;return function(){return t+String(++e)+"/"+String(Date.now())}}(),l=function(){function t(){this._status=c.PENDING,this.promise=new Promise(function(t,e){this._resolveHandler=t,this._rejectHandler=e}.bind(this)),Object.defineProperties(this,{status:{get:e}})}function e(){return this._status}function r(){var t=this._resolveHandler.apply(null,arguments);return this._status=c.RESOLVED,t}function n(){var t=this._rejectHandler.apply(null,arguments);return this._status=c.REJECTED,t}function o(){return new t}return t.prototype.resolve=r,t.prototype.reject=n,o}(),d=function(){function t(t,u,a,c){Object.defineProperty(this,h,{value:{active:!0,pool:t,resource:u,type:a,id:c}}),Object.defineProperty(this,p,{get:e}),Object.defineProperties(this,{active:{get:r},poolId:{get:n},resource:{get:o},type:{get:i},id:{get:s}})}function e(){return this.toJSON()}function r(){return Boolean(this[h].active)}function n(){return this[h].pool?this[h].pool.id:null}function o(){return this[h].resource}function i(){return this[h].type||typeof this[h].resource}function s(){return this[h].id}function u(){var t={};return t[p]={id:this[h].id,type:this.type,poolId:this.poolId},t}function a(){var t=this[h].id,e=this[h].pool;if(this[h].active){this[h].active=!1,e.remove(t);for(var r in this[h])delete this[h][r]}}function c(e,r,n){return new t(e,r,n||f())}return t.prototype.toJSON=u,t.prototype.destroy=a,t.create=c,t}(),v=function(){function t(){this[v]=new Map,Object.defineProperties(this,{id:{value:f()}}),u.apply(this)}function e(e,r){var n=null;return t.isValidTarget(e)&&(this[v].has(e)?n=this[v].get(e):(n=d.create(this,e,r||typeof e),this[v].set(n.id,n),this[v].set(e,n),this.hasEventListener(l.RESOURCE_ADDED)&&this.dispatchEvent(l.RESOURCE_ADDED,n))),n}function r(t){return this[v].has(t)}function n(t){return this[v].get(t)}function o(t){var e=this[v].get(t);e&&(this[v]["delete"](e.id),this[v]["delete"](e.resource),this.hasEventListener(l.RESOURCE_REMOVED)&&this.dispatchEvent(l.RESOURCE_REMOVED,e),e.destroy())}function i(){this.hasEventListener(l.POOL_CLEAR)&&this.dispatchEvent(l.POOL_CLEAR,this);for(var t=this[v].keys(),e=t.length,r=0;e>r;r++){var n=t[r];if("string"==typeof n){var o=this[v].get(n);o.destroy()}}this[v].clear(),this.hasEventListener(l.POOL_CLEARED)&&this.dispatchEvent(l.POOL_CLEARED,this)}function s(){this.hasEventListener(l.POOL_DESTROY)&&this.dispatchEvent(l.POOL_DESTROY,this),this.clear(),this[v]=null,y.remove(this),this.hasEventListener(l.POOL_DESTROYED)&&this.dispatchEvent(l.POOL_DESTROYED,this)}function a(t){return t&&E[typeof t]}function c(t){E={};for(var e=t.length,r=0;e>r;r++)E[t[r]]=!0}function h(){return["object","function"]}function p(){return new t}var l={RESOURCE_ADDED:"resourceAdded",RESOURCE_REMOVED:"resourceRemoved",POOL_CLEAR:"poolClear",POOL_CLEARED:"poolCleared",POOL_DESTROY:"poolDestroy",POOL_DESTROYED:"poolDestroyed"},v=Symbol("TargetPool::map"),E={};return t.prototype=u.createNoInitPrototype(),t.prototype.constructor=t,t.prototype.set=e,t.prototype.has=r,t.prototype.get=n,t.prototype.remove=o,t.prototype.clear=i,t.prototype.destroy=s,t.isValidTarget=a,t.setValidTargets=c,t.getDefaultValidTargets=h,t.create=p,t.Events=l,t.setValidTargets(t.getDefaultValidTargets()),t}(),y=function(){function t(){var t=v.create();return e(t),t}function e(t){u[t.id]=t,t.addEventListener(v.Events.POOL_DESTROY,this._poolDestroyListener)}function r(t){return u[t]||null}function n(t){return u.hasOwnProperty(t instanceof v?t.id:String(t))}function o(t){var e=!1;return t=t instanceof v?t:r(t),t&&(t.removeEventListener(v.Events.POOL_DESTROY,this._poolDestroyListener),e=delete u[t.id]),e}function i(t){o(t.data)}function s(){}var u={};return s.prototype.createPool=t,s.prototype.register=e,s.prototype.get=r,s.prototype.isRegistered=n,s.prototype.remove=o,s.prototype._poolDestroyListener=i,new s}(),E=function(){function t(t,e){this[v]=t,u.apply(this),e&&e.setConverter(this)}function r(t){var r;return s(t)?r=e(t):"function"==typeof t.toJSON&&(r=t.toJSON()),r!==t&&this.hasEventListener(E.RESOURCE_CONVERTED)&&this.dispatchEvent(E.RESOURCE_CONVERTED,{data:t,result:r}),r}function a(t){var e,r=o(t);return y.isRegistered(r)?(t=y.get(r).get(n(t)),t&&(e=t.resource)):e=this[v].create(Promise.resolve(t)),e!==t&&this.hasEventListener(E.RESOURCE_CREATED)&&this.dispatchEvent(E.RESOURCE_CREATED,{data:t,result:e}),e}function c(t,e){for(var r=[],n=t.length,o=0;n>o;o++)r[o]=e.call(this,t[o]);return r}function h(t,e){var r={};for(var n in t)t.hasOwnProperty(n)&&(r[n]=e.call(this,t[n]));return r}function p(t){var e=t;return void 0!==t&&null!==t&&(s(t)?e=this.resourceToObject(t):t instanceof Array?e=this.lookupArray(t,this.resourceToObject):t.constructor===Object&&(e=this.lookupObject(t,this.resourceToObject))),e}function f(t){var e=t;return void 0!==t&&null!==t&&(i(t)?e=this.objectToResource(t):t instanceof Array?e=this.lookupArray(t,this.objectToResource):t.constructor===Object&&(e=this.lookupObject(t,this.objectToResource))),e}function l(t){function e(t){return P.isPending(t)&&r.push(t),t}var r=[];return"object"==typeof t&&null!==t&&(P.isPending(t)?r.push(t):t instanceof Array?this.lookupArray(t,e):t.constructor===Object&&this.lookupObject(t,e)),r}function d(e,r){return new t(e,r)}var v=Symbol("resource.converter::factory"),E={RESOURCE_CREATED:"resourceCreated",RESOURCE_CONVERTED:"resourceConverted"};return t.prototype=u.createNoInitPrototype(),t.prototype.constructor=t,t.prototype.toJSON=p,t.prototype.parse=f,t.prototype.lookupArray=c,t.prototype.lookupObject=h,t.prototype.lookupForPending=l,t.prototype.resourceToObject=r,t.prototype.objectToResource=a,t.create=d,t}(),O=function(){function t(){return!1}function e(){function r(t){c=t}function n(t){p=e.filterHandlers(t)}function o(t){return p.hasOwnProperty(t)}function i(){return p}function s(t){return p[t]||null}function u(t,e,r){var n=c?c.lookupForPending(e.value):null;n&&n.length?Promise.all(n).then(function(){a(t,e.type,e,r)}):a(t,e.type,e,r)}function a(t,e,r,n){var o=s(e);"function"==typeof o&&o(t,r,n)}var c,h=t,p={};Object.defineProperties(this,{isTemporary:{get:function(){return h},set:function(e){h="function"==typeof e?e:t}}}),this.setConverter=r,this.setHandlers=n,this.hasHandler=o,this.getHandlers=i,this.getHandler=s,this.handle=u}function r(t){var e={};for(var r in t)if(t.hasOwnProperty(r)&&"function"==typeof t[r]){if(r in a)throw new Error('Name "'+r+'" is reserved and cannot be used as command handler.');e[r]=t[r]}return e}function n(){return new e}return e.filterHandlers=r,e.create=n,e}(),g=function(){function t(t,e){function r(e){return o.hasOwnProperty(e)||(o[e]=function(e){function r(r,n){var o=this[h].sendRequest(e,r,n);return t.create(o||Promise.reject("Initial request failed and didn't result in promise."))}return r}(e)),o[e]}function n(t){var n=e.getHandlers();for(var o in n)t[o]=r(o);return t}var o={};this.decorate=n}function e(e){return new t(e)}return t.create=e,t}(),R=function(){function t(t){this[o]=t,this[n]=new g(this,t)}function e(t){var e=P.create(t,this[o]);return this[n].decorate(e),e}function r(e){return new t(e)}var n=Symbol("request.factory::decorator"),o=Symbol("request.factory::handlers");return t.prototype.create=e,t.create=r,t}(),D=function(){function t(t,e,r){this._requestHandlers=r,this._requestTarget=t,this.link={},this.temporary,this.hadChildPromises=!1,this.status=c.PENDING,this.queue=[],this.promise=e.then(this._resolveHandler.bind(this),this._rejectHandler.bind(this))}function e(t){return this.status=c.RESOLVED,i(t)&&(this.link=r(t),this.temporary=this._requestHandlers.isTemporary(this._requestTarget),this.temporary&&this.queue[this.queue.length-1][1].promise.then(this.destroy.bind(this),this.destroy.bind(this)),t={target:this}),this._sendQueue(),t}function n(t){for(this.status=c.REJECTED;this.queue&&this.queue.length;){var e=this.queue.shift();e[1].reject(new Error("Target of the call was rejected and call cannot be sent."))}return this.queue=null,t}function o(){for(;this.queue&&this.queue.length;){var t=this.queue.shift(),e=t[0],r=t[1];e.target=this.link.id,this._requestHandlers.handle(this._requestTarget,e,r)}this.queue=null}function s(e,r,n){var o=null;if(!this._requestHandlers.hasHandler(e))throw new Error('Request handler of type "'+e+'" is not registered.');var i=t.createRequestPackage(e,r,n,this.id);return o=this._applyRequest(i,l())}function u(t,e){this.queue.push([t,e])}function h(t,e){var r=e.promise;t.type;switch(this.status){case c.PENDING:this._addToQueue(t,e);break;case c.REJECTED:r=Promise.reject(new Error("Target object was rejected and cannot be used for calls."));break;case c.DESTROYED:r=Promise.reject(new Error("Target object was destroyed and cannot be used for calls."));break;case c.RESOLVED:this._requestHandlers.handle(this._requestTarget,t,e)}return r}function f(){return this.status===c.PENDING||this.status===c.RESOLVED}function d(){return this.status===c.RESOLVED&&this.link.id}function v(){var t=null;return this.canBeDestroyed()?(this.status=c.DESTROYED,t=this.sendRequest(a.DESTROY_TARGET)):t=Promise.reject(),t}function y(){var t=this.promise.then.apply(this.promise,arguments);return t&&(this.hadChildPromises=!0),t}function E(){var t=this.promise["catch"].apply(this.promise,arguments);return t&&(this.hadChildPromises=!0),t}function O(){var t={};return t[p]={id:this.link.id,type:this.link.type,poolId:this.link.poolId},t}function g(t,e,r,n){return{type:t,cmd:e,value:r,target:n}}return t.prototype._resolveHandler=e,t.prototype._rejectHandler=n,t.prototype._sendQueue=o,t.prototype.sendRequest=s,t.prototype._addToQueue=u,t.prototype._applyRequest=h,t.prototype.isActive=f,t.prototype.canBeDestroyed=d,t.prototype.destroy=v,t.prototype.then=y,t.prototype["catch"]=E,t.prototype.toJSON=O,t.isTemporary=_isTemporary,t.createRequestPackage=g,t}(),P=function(){function t(t,e){Object.defineProperty(this,h,{value:new D(this,t,e)})}function e(){this[h].then.apply(this[h],arguments)}function r(){this[h]["catch"].apply(this[h],arguments)}function n(t){return t[h].isActive()}function o(t){return t[h].canBeDestroyed()}function i(t){return t[h].destroy()}function s(t){return t[h].toJSON()}function u(e){return e instanceof t&&a(e)==c.PENDING}function a(t){return t[h].status}function p(t){var e=t[h].queue;return e?e.length:0}function f(t){var e,r=[],n=t[h].queue;if(n){e=n.length;for(var o=0;e>o;o++)r.push(n[o][0].type)}return r}function l(e,r){return new t(e,r)}return t.prototype.then=e,t.prototype["catch"]=r,t.isActive=n,t.canBeDestroyed=o,t.destroy=i,t.toJSON=s,t.isPending=u,t.getStatus=a,t.getQueueLength=p,t.getQueueCommands=f,t.create=l,t}(),_=function(){function e(){var e=O.create(),r=R.create(e);Object.defineProperties(this,{poolRegistry:{value:y},pool:{value:y.createPool()},resourceConverter:{value:E.create(r,e)},factory:{value:r},IConvertible:{value:t},RequestTarget:{value:P}}),this.setHandlers=e.setHandlers}function r(t){return this.resourceConverter.parse(t)}function n(t){return this.resourceConverter.toJSON(t)}return e.prototype.parse=r,e.prototype.toJSON=n,e}();return _});
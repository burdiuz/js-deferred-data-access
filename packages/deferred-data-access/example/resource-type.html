<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Deferred Data Access Example</title>
  <script type="text/javascript" src="../dist/deferred-data-access.standalone.js"></script>
  <script type="text/javascript">
    var participants;
    function messageHandler(target, pack, deferred) {
      deferred.resolve();
    }
    var api = DataAccessInterface.create({
      message: messageHandler
    }, false);
    var socket = new WebSocket('ws://localhost:8081/ws');
    socket.onopen = function() {
      console.log('open', arguments);
      //TODO create UI to request name
      socket.send(JSON.stringify({
        type: 'init',
        name: 'First one'
      }));
    };
    socket.onerror = function() {
      //TODO Error should be displayed as system message and then display UI to request name
      console.log('error', arguments);
    };
    socket.onclose = function() {
      //TODO After closing connection, try to reconnect and then display UI to request name
      console.log('close', arguments);
    };
    socket.onmessage = function(event) {
      console.log('message', arguments);
      var message = JSON.parse(event.data);
      switch (message.type) {
        case 'participants':
          participants = api.parse(message.data); // this will create resources for each participant
          break;
        case 'participantAdd':
          participants.push(api.parse(message.source));
          break;
        case 'participantRemove':
          var sourceId = DataAccessInterface.getResourceId(message.source);
          for (var index = 0; index < participants.length; index++) {
            if (DataAccessInterface.getResourceId(participants[index]) === sourceId) {
              participants.splice(index, 1);
              break;
            }
          }
          break;
        case 'message':
          //TODO display message, should we display difference between private and global messages?
          break;
        case 'system':
          //TODO display system message
          break;
      }
    };
  </script>
  <!--script type="text/javascript">
    // Create interface
    var api;
    var ProxyCommands = DataAccessInterface.ProxyCommands;
    var Descriptor = DataAccessInterface.Descriptor;
    var proxyCommands = ProxyCommands.createDescriptors({
      get: function(res, cmd, def) {
        console.log('GET', res, cmd, def);
      },
      set: function(res, cmd, def) {
        console.log('SET', res, cmd, def);
      },
      apply: function(res, cmd, def) {
        console.log('APPLY', res, cmd, def);
      }
    });

    // duplicate commands for legacy access
    proxyCommands.get = Descriptor.create('get', function(res, cmd, def) {
      console.log('Legacy GET', res, cmd, def);
    });
    proxyCommands.set = Descriptor.create('set', function(res, cmd, def) {
      console.log('Legacy SET', res, cmd, def);
    });
    ;
    proxyCommands.apply = Descriptor.create('apply', function(res, cmd, def) {
      console.log('Legacy APPLY', res, cmd, def);
    });

    // Setup commands that can be applied to request targets
    api = new DataAccessInterface(proxyCommands, true);
    // emulate remote object
    var pool = DataAccessInterface.ResourcePool.create();
    var resource = pool.set({id: '11111', poolId: '222222', type: 'object'});
    // create a request target
    var request = api.factory.create(Promise.resolve(resource.toJSON()));
    // make a request
    request.get('My Command', 'any-value-here');
    // make Proxy'ed request
    request.MyCommand = 'any-value-here';
  </script-->
</head>
<body>
</body>
</html>
